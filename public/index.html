import React, { useState } from 'react';
import { FileText, Mail, Copy, Check, Loader2, AlertCircle } from 'lucide-react';

const NewsletterBuilder = () => {
  const [urls, setUrls] = useState(['', '', '']);
  const [articles, setArticles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [copied, setCopied] = useState(false);
  const [apiEndpoint, setApiEndpoint] = useState('https://newsletter-builder-tawny.vercel.app/api/fetch-article');

  const extractMetadata = async (url) => {
    try {
      const response = await fetch(apiEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ url })
      });

      if (!response.ok) {
        throw new Error('Failed to fetch article');
      }

      return await response.json();
    } catch (err) {
      console.error('Error fetching:', url, err);
      throw err;
    }
  };

  const handleFetchArticles = async () => {
    setLoading(true);
    setError('');
    setArticles([]);

    const validUrls = urls.filter(url => url.trim());
    
    if (validUrls.length < 2) {
      setError('Please enter at least 2 article URLs');
      setLoading(false);
      return;
    }

    try {
      const results = await Promise.allSettled(
        validUrls.map(url => extractMetadata(url))
      );

      const validArticles = results
        .filter(result => result.status === 'fulfilled')
        .map(result => result.value);
      
      if (validArticles.length === 0) {
        setError('Could not fetch any articles. Make sure the backend API is accessible.');
        setLoading(false);
        return;
      }

      validArticles.sort((a, b) => b.wordCount - a.wordCount);
      setArticles(validArticles);
      
      if (validArticles.length < validUrls.length) {
        setError(`Successfully fetched ${validArticles.length} out of ${validUrls.length} articles.`);
      }
    } catch (err) {
      setError('Error fetching articles. Please check the API endpoint.');
      console.error(err);
    }

    setLoading(false);
  };

  const generateNewsletterHTML = () => {
    if (articles.length === 0) return '';

    const mainArticle = articles[0];
    const subArticles = articles.slice(1);

    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Newsletter</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    .container { max-width: 600px; margin: 0 auto; background: white; }
    .header { background: #2563eb; color: white; padding: 30px 20px; text-align: center; }
    .header h1 { margin: 0; font-size: 28px; }
    .content { padding: 30px 20px; }
    .section { margin-bottom: 40px; }
    .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #6b7280; margin-bottom: 15px; font-weight: 600; }
    .article { margin-bottom: 25px; }
    .article-title { font-size: 22px; font-weight: 700; color: #111827; margin-bottom: 10px; line-height: 1.3; }
    .article-title a { color: #111827; text-decoration: none; }
    .article-title a:hover { color: #2563eb; }
    .article-excerpt { font-size: 15px; color: #4b5563; line-height: 1.6; margin-bottom: 12px; }
    .article-link { color: #2563eb; text-decoration: none; font-weight: 600; font-size: 14px; }
    .article-link:hover { text-decoration: underline; }
    .sub-article { border-left: 3px solid #e5e7eb; padding-left: 15px; margin-bottom: 20px; }
    .sub-article-title { font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 8px; line-height: 1.3; }
    .sub-article-title a { color: #111827; text-decoration: none; }
    .quick-read { background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 12px; }
    .quick-read-title { font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 5px; }
    .quick-read-title a { color: #111827; text-decoration: none; }
    .footer { background: #f9fafb; padding: 20px; text-align: center; font-size: 13px; color: #6b7280; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ“° Newsletter</h1>
    </div>
    
    <div class="content">
      <!-- Main Story -->
      <div class="section">
        <div class="section-title">Main Story</div>
        <div class="article">
          <h2 class="article-title"><a href="${mainArticle.url}">${mainArticle.title}</a></h2>
          <p class="article-excerpt">${mainArticle.excerpt}</p>
          <a href="${mainArticle.url}" class="article-link">Read full article â†’</a>
        </div>
      </div>

      ${subArticles.length > 0 ? `
      <!-- Other Stories -->
      <div class="section">
        <div class="section-title">Other Stories</div>
        ${subArticles.map(article => `
        <div class="sub-article">
          <h3 class="sub-article-title"><a href="${article.url}">${article.title}</a></h3>
          <p class="article-excerpt">${article.excerpt.substring(0, 150)}...</p>
          <a href="${article.url}" class="article-link">Read more â†’</a>
        </div>
        `).join('')}
      </div>
      ` : ''}

      <!-- Quick Reads -->
      <div class="section">
        <div class="section-title">Quick Reads</div>
        ${articles.map(article => `
        <div class="quick-read">
          <div class="quick-read-title"><a href="${article.url}">${article.title}</a></div>
        </div>
        `).join('')}
      </div>

      <!-- Recommended Reads -->
      <div class="section">
        <div class="section-title">Recommended Reads</div>
        ${articles.slice().reverse().map(article => `
        <div class="quick-read">
          <div class="quick-read-title"><a href="${article.url}">${article.title}</a></div>
        </div>
        `).join('')}
      </div>
    </div>

    <div class="footer">
      <p>Thanks for reading! ðŸ“š</p>
    </div>
  </div>
</body>
</html>`;
  };

  const copyHTML = () => {
    const html = generateNewsletterHTML();
    navigator.clipboard.writeText(html);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
            <Mail className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-4xl font-bold text-gray-900 mb-2">Newsletter Builder</h1>
          <p className="text-gray-600">Transform article URLs into beautiful newsletters</p>
        </div>

        <div className="mb-6 bg-green-50 border-2 border-green-300 rounded-lg p-4">
          <h3 className="font-bold text-green-900 mb-2 flex items-center gap-2">
            <Check className="w-5 h-5" />
            Ready to Use - Backend Deployed
          </h3>
          <div className="text-sm text-green-800">
            <p>âœ“ Backend is hosted on Vercel (no local setup needed)</p>
            <p>âœ“ Just paste your article URLs and click Generate</p>
            <p className="mt-2 text-xs">Using API: <code className="bg-green-100 px-2 py-1 rounded">{apiEndpoint}</code></p>
          </div>
        </div>

        <div className="grid lg:grid-cols-2 gap-8">
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <FileText className="w-5 h-5" />
              Article URLs
            </h2>
            
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                API Endpoint (optional)
              </label>
              <input
                type="text"
                value={apiEndpoint}
                onChange={(e) => setApiEndpoint(e.target.value)}
                placeholder="https://your-project.vercel.app/api/fetch-article"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <p className="text-xs text-gray-500 mt-1">Default uses deployed Vercel backend</p>
            </div>

            <div className="space-y-3 mb-6">
              {urls.map((url, index) => (
                <div key={index}>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Article {index + 1} {index < 2 && <span className="text-red-500">*</span>}
                  </label>
                  <input
                    type="url"
                    value={url}
                    onChange={(e) => {
                      const newUrls = [...urls];
                      newUrls[index] = e.target.value;
                      setUrls(newUrls);
                    }}
                    placeholder="https://fitpreethi.com/article-url"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              ))}
            </div>

            {error && (
              <div className={`mb-4 p-3 border rounded-lg text-sm flex items-start gap-2 ${
                articles.length > 0 ? 'bg-yellow-50 border-yellow-200 text-yellow-800' : 'bg-red-50 border-red-200 text-red-700'
              }`}>
                <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
                <span>{error}</span>
              </div>
            )}

            <button
              onClick={handleFetchArticles}
              disabled={loading}
              className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {loading ? (
                <>
                  <Loader2 className="w-5 h-5 animate-spin" />
                  Fetching Articles...
                </>
              ) : (
                'Generate Newsletter'
              )}
            </button>

            {articles.length > 0 && (
              <button
                onClick={copyHTML}
                className="w-full mt-3 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
              >
                {copied ? (
                  <>
                    <Check className="w-5 h-5" />
                    Copied!
                  </>
                ) : (
                  <>
                    <Copy className="w-5 h-5" />
                    Copy Newsletter HTML
                  </>
                )}
              </button>
            )}
          </div>

          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-xl font-semibold mb-4">Newsletter Preview</h2>
            
            {articles.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <Mail className="w-12 h-12 mx-auto mb-3 opacity-30" />
                <p>Enter article URLs and click Generate Newsletter</p>
              </div>
            ) : (
              <div className="border border-gray-200 rounded-lg overflow-hidden overflow-y-auto max-h-[600px]">
                <div dangerouslySetInnerHTML={{ __html: generateNewsletterHTML() }} />
              </div>
            )}
          </div>
        </div>

        <div className="mt-8 bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="font-semibold text-gray-900 mb-3">How it works:</h3>
          <ul className="space-y-2 text-gray-700 text-sm">
            <li>âœ“ Backend server fetches article HTML (bypasses CORS restrictions)</li>
            <li>âœ“ Extracts metadata: title, description, Open Graph tags, word count</li>
            <li>âœ“ Articles auto-sorted by length (longest = main story)</li>
            <li>âœ“ Generates 4 sections: Main Story, Other Stories, Quick Reads, Recommended Reads</li>
            <li>âœ“ Copy HTML and paste into any email service provider</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

export default NewsletterBuilder;
